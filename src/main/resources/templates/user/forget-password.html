<!DOCTYPE>
<html lang="ch">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘记密码</title>
    <link type="text/css" rel="stylesheet" href="/static/user/css/forgetpwd.css"/>
    <link href="/static/public/css/element-ui.css" type="text/css" rel="stylesheet">
    <script src="/static/public/js/vue.js"></script>
    <script src="/static/public/js/axios.js"></script>
    <script src="/static/public/js/element-ui.js"></script>
    <script src="/static/public/js/md5.js"></script>
    <script src="/static/public/js/jquery.main.js"></script>
    <link href="/favicon.ico" rel="icon">
</head>
<style>
    li{
        display: flex;
    }
    svg{
        vertical-align: middle;
    }
</style>
<body>
<div class="main" id="forgetPassword">
    <div class="main0">
        <div class="formBox">
            <h3>登录密码重置</h3>
            <ul>
                <li class="mainCol firLi">
                    <svg t="1698682970818" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4071" width="32" height="32"><path d="M809.8816 139.5712H225.536c-80.1792 0-145.408 65.2288-145.408 145.408v447.0784c0 80.1792 65.2288 145.408 145.408 145.408h584.3456c80.1792 0 145.408-65.2288 145.408-145.408V285.0304c0-80.2304-65.2288-145.4592-145.408-145.4592z" fill="#7B79FF" p-id="4072"></path><path d="M461.7216 515.7888a123.66336 123.66336 0 0 0 33.6896-84.9408c0-68.4544-55.7056-124.2112-124.2112-124.2112S247.04 362.3424 247.04 430.848c0 32.8192 12.8512 62.72 33.6896 84.9408-45.8752 29.7472-76.288 81.3568-76.288 140.032 0 18.2272 14.7968 33.024 33.024 33.024s33.024-14.7968 33.024-33.024c0-55.552 45.2096-100.7616 100.7616-100.7616s100.7616 45.2096 100.7616 100.7616c0 18.2272 14.7968 33.024 33.024 33.024s33.024-14.7968 33.024-33.024c0-58.6752-30.464-110.2848-76.3392-140.032zM313.088 430.848c0-32.0512 26.0608-58.1632 58.1632-58.1632 32.0512 0 58.1632 26.112 58.1632 58.1632s-26.0608 58.1632-58.1632 58.1632c-32.0512 0-58.1632-26.112-58.1632-58.1632zM811.4176 564.6336h-172.288c-18.2272 0-33.024 14.7968-33.024 33.024s14.7968 33.024 33.024 33.024h172.288c18.2272 0 33.024-14.7968 33.024-33.024s-14.7968-33.024-33.024-33.024zM639.1296 451.5328h103.7824c18.2272 0 33.024-14.7968 33.024-33.024s-14.7968-33.024-33.024-33.024h-103.7824c-18.2272 0-33.024 14.7968-33.024 33.024s14.7968 33.024 33.024 33.024z" fill="#FFFFFF" p-id="4073"></path></svg>
                    身份验证</li>
                <li class="">
                    <svg t="1698683045472" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8447" width="32" height="32"><path d="M251.566 759.85c-16.994 0-30.82-13.572-30.82-30.275V451.64h493.14v77.833a196.856 196.856 0 0 1 46.23 9.612V405.409h-585.6v324.166c0 42.262 34.497 76.504 77.05 76.504h263.418a197.072 197.072 0 0 1-13.699-46.23h-249.72z m446.91-354.441h-46.23v-46.24c0-103.956-86.809-184.92-184.921-184.92-100.534 0-184.921 84.368-184.921 184.92v46.24h-46.23v-46.24c0-126.038 105.112-231.16 231.16-231.16 124.454 0 231.16 100.835 231.16 231.16v46.24z" p-id="8448"></path><path d="M459.606 528.69h15.42a23.12 23.12 0 0 1 23.11 23.11v107.88a23.129 23.129 0 0 1-23.138 23.119h-15.41a23.12 23.12 0 0 1-23.12-23.12V551.81a23.156 23.156 0 0 1 23.138-23.12z m237.186 31.939c-91.87 0-166.316 74.465-166.316 166.307 0 91.86 74.456 166.315 166.316 166.315 91.85 0 166.315-74.465 166.315-166.315 0-91.842-74.465-166.307-166.315-166.307z m1.702 287.266c-69.632 0-126.075-56.425-126.075-126.075 0-69.623 56.434-126.066 126.075-126.066s126.075 56.434 126.075 126.066c0 69.65-56.434 126.075-126.075 126.075z" p-id="8449"></path><path d="M693.169 778.363h14.91v13.48h-14.91z" p-id="8450"></path><path d="M684.067 769.26h33.114v31.686h-33.114zM705.23 641.42c-27.908-0.464-45.657 13.253-53.212 41.151h12.06c6.618-22.7 20.325-33.814 41.151-33.341 20.335 1.41 31.458 11.824 33.35 31.22 1.42 10.878-6.38 21.764-23.41 32.632-14.664 9.475-21.763 20.826-21.29 34.06v7.091h12.06v-6.38c-0.473-11.824 4.733-21.045 15.61-27.671 21.29-11.35 31.221-25.068 29.801-41.151-2.375-23.648-17.74-36.19-46.12-37.61z" p-id="8451"></path><path d="M715.042 763.344h-30.265v-16.192c-0.583-16.275 7.973-30.42 25.45-41.707 9.475-6.044 20.47-15.055 19.333-23.802-1.502-15.328-8.957-22.2-24.959-23.32h-0.628c-10.021 0-24.148 2.785-31.148 26.797l-1.911 6.563H640.13l3.113-11.487c8.484-31.321 29.446-47.887 60.63-47.887l1.511 0.009c41.943 2.094 53.048 26.06 55.032 45.802 1.766 20.107-9.876 36.919-34.58 50.099-7.554 4.624-11.14 10.823-10.804 19.27l0.01 15.855z" p-id="8452"></path></svg>
                    登录密码重置</li>
                <li class="lastLi">
                    <svg t="1698683086720" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9513" width="32" height="32"><path d="M0 512C0 229.248 229.248 0 512 0s512 229.248 512 512-229.248 512-512 512S0 794.752 0 512z" fill="#5A91F7" p-id="9514"></path><path d="M512 192c176.768 0 320 143.232 320 320S688.768 832 512 832 192 688.768 192 512s143.232-320 320-320z" fill="#FFFFFF" p-id="9515"></path><path d="M691.968 436.864a34.944 34.944 0 0 0-46.08-17.92c-2.944 1.28-5.632 2.944-8.192 4.992L488.576 546.56c-13.184 10.88-32.256 10.624-45.184-0.64l-53.632-46.464a42.2784 42.2784 0 0 0-63.872 10.24c-9.856 16.512-7.296 37.632 6.272 51.328l108.8 109.568a34.9952 34.9952 0 0 0 49.536 0.128l0.128-0.128 194.048-195.072c10.24-10.112 13.056-25.472 7.296-38.656" fill="#5A91F7" p-id="9516"></path></svg>
                    重置完成</li>
            </ul>
            <!--         第一步-->
            <div class="view-1" v-show="visible===1">
                <img src="/static/user/images/lorefopw/line.png"/>
                <div class="itembox">
                    <label>邮箱地址&nbsp;:</label>
                    <label>
                        <input v-model="accountEmail" @input="validateEmail" type="text" placeholder="请输入注册邮箱号">
                    </label>
                    <span class="verify-rules-text" style="color: red">{{emailVerifyRules}}</span>
                </div>

                <div class="itembox itembox_2">
                    <label>验证码&nbsp;:</label>
                    <label>
                        <input name="" v-model="verifyInput" type="text" class="txtyzm" placeholder="请输入页面验证码"/>
                    </label>
                    <img class="yzmimg" :src="verifyCodeData" alt="更换验证码" @click="getVerify" height="32"
                         width="140">
                </div>
                <div class="btnBox">
                    <button type="button" @click="nextToOne">下一步</button>
                </div>
                <div style="position: relative;left: -15px"><el-button type="text" @click="toLogin">其实我没有忘记密码</el-button></div>
            </div>

            <!--         第二步-->
            <div class="view-2" v-show="visible===2">
                <img src="/static/user/images/lorefopw/line2.png" alt=""/>
                <div>
                    <div class="itembox itembox_2">
                        <label>邮箱验证码 &nbsp;:</label>
                        <label>
                            <input name="" v-model="inputVerifyCode" type="text" placeholder="请输入邮箱验证码"
                                   class="txtyzmdx"/>
                        </label>
                        <div class="el-send-box">
                            <button class="el-send" @click="sendVerificationCode" :disabled="countdown > 0">
                                {{countdown > 0 ? `${countdown}秒后重新发送` : '发送验证码'}}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="itembox itembox_2">
                    <label>登录密码&nbsp;:</label>
                    <label>
                        <input type="password" v-model="rePwd" placeholder="请输入新登录密码">
                    </label>
                </div>
                <div class="itembox itembox_2">
                    <label>确认密码&nbsp;:</label>
                    <label>
                        <input type="password" v-model="cfrmPwd" placeholder="请再次输入新密码">
                    </label>
                </div>
                <div class="btnBox">
                    <button type="button" @click="nextToTwo">下一步</button>
                </div>
            </div>
            <!--         第三步-->
            <div class="view-3" v-show="visible===3">
                <img src="/static/user/images/lorefopw/line3.png"/>
                <p class="sub"><span>-^0^-</span> 新登录密码重置成功，请重新登录!</p>
                <div class="btnBox_2">
                    <button onclick="window.location.href='/user/login-register'">重新登录</button>
                </div>
            </div>
        </div>


    </div>
</div>

<div class="footer">
    <div class="footer0">
        <div class="footer_l">使用条款 | 隐私保护</div>
        <div class="footer_r">© 2015 （成都）花维电子商务服务有限公司 蜀ICP备0000000号</div>
    </div>
</div>


<script>
    new Vue({
        el: "#forgetPassword",
        data() {
            return {
                visible: 1,
                inputVerifyCode: "",
                countdown: 0,
                verifyInput: "",
                verifyCode: "",
                verifyCodeData: "",
                accountEmail: "",
                cfrmPwd: "",
                rePwd: "",
                emailVerifyRules: ""
            }
        },
        created() {
            this.getVerify()
        },
        methods: {
            toLogin(){
              window.location.href="/user/login-register"
            },
            showVisible(index) {
                this.visible = index
            },
            clearInput(index) {
                if (index === 1) {

                    this.verifyInput = ""

                }
                if (index === 2) {
                    this.inputVerifyCode = ""
                    this.rePwd = ""
                    this.cfrmPwd = ""
                }
                if (index === 3) {
                    this.accountEmail = ""
                    this.verifyInput = ""
                }
            },
            async nextToOne() {
                if (this.validateEmail()) {
                    //校验输入
                    if (await this.proVerRes() && this.verifyInput !== "") {
                        axios.post("/web/tws/fs/api/v3/userIsExists?acc=" + this.accountEmail).then(response => {
                            if (response.data.code === 0) {
                                this.showVisible(2)
                            } else {
                                this.$notify({
                                    title: '警告',
                                    message: '该账号还未注册哦！',
                                    type: 'warning'
                                });
                                this.getVerify()
                                this.clearInput(3)
                            }
                        })

                    } else {
                        this.$message.error("验证码输入错误")
                        this.getVerify()
                        this.clearInput(1)
                    }
                } else {
                    this.$message.error("请正确输入邮箱地址")
                }
            },
            sendVerificationCode() {
                if (this.countdown > 0) {
                    // 如果倒计时还在进行中，不允许再次发送
                    return;
                }

                // 发送验证码的逻辑，这里假设你有一个发送验证码的函数 sendCode()
                // 调用 sendCode() 后开始倒计时
                this.$notify({
                    title: '成功',
                    message: '操作成功，请等待系统处理',
                    type: 'success'
                });
                this.sendCode();

                // 设置倒计时为60秒，你可以根据需要调整时间
                this.countdown = 60;

                // 创建定时器，每秒减少倒计时
                const timer = setInterval(() => {
                    if (this.countdown > 0) {
                        this.countdown--;
                    } else {
                        // 倒计时结束时清除定时器
                        clearInterval(timer);
                    }
                }, 1000);
            },
            getVerify() {
                fetch("/web/tws/fs/api/v2/getVerify?" + Math.random())
                    .then((response) => response.blob())
                    .then((blob) => {
                        // 创建一个 URL 对象
                        const blobUrl = URL.createObjectURL(blob);

                        // 将 URL 对象设置为图像链接
                        this.verifyCodeData = blobUrl;
                    })
                    .catch((error) => console.error(error));
            },
            async verifyInputCode() {
                try {
                    const response = await axios.post("/web/tws/fs/api/v2/checkVerify", {"verifyInput": this.verifyInput});
                    console.log(response)
                    return response.data;

                } catch (error) {
                    console.log(error);
                    throw error;
                }
            },
            async proVerRes() {
                try {
                    const data = await this.verifyInputCode();
                    console.log(data); // 处理返回的数据
                    return data
                } catch (error) {
                    console.log(error); // 处理错误
                }
            },
            sendCode() {
                axios.post("/web/tws/fs/api/v1/email?q=" + this.accountEmail).then(response => {
                        this.$message.success("验证码发送成功，请注意查收")
                        this.verifyCode = response.data.response.data
                    }
                )
            },
            //邮箱地址校验
            validateEmail() {
                const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

                if (regex.test(this.accountEmail)) {
                    this.emailVerifyRules = '';
                    return true
                } else {
                    this.emailVerifyRules = '邮箱地址格式不正确';
                    return false
                }
            },
            reChangePwd() {
                if (this.rePwd !== "" && this.cfrmPwd !== "") {
                    if (this.inputVerifyCode === this.verifyCode) {
                        axios.post("/web/tws/fs/api/v3/forget-password",
                            {
                                "newPwd": md5(this.rePwd),
                                "account": this.accountEmail
                            }
                        ).then(response => {
                            if (response.data.code === 0) {
                                this.showVisible(3)
                                this.clearInput(3)
                                this.clearInput(2)
                            } else {
                                this.$message.error("密码重置失败")
                                this.clearInput(3)
                                this.clearInput(2)
                                this.showVisible(1)
                            }
                        }).catch(error => {
                            console.log(error)
                            this.$message.error("系统异常，请稍后再试")
                        })
                    } else {
                        this.$message.error("验证码不正确哦！")
                        this.getVerify()
                        this.clearInput(1)
                    }

                } else {
                    this.$message.error("请正确输入内容")
                }
            },
            nextToTwo() {
                this.reChangePwd()
            }
        }
    })
</script>
<script>
    $(document).ready(function () {
        var height = $(document).height();
        $('.main').css('height', height);
    })
</script>
</body>
</html>
